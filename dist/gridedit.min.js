/*! vision-editors 2014-02-15 */
function sqlite_open(a,b,c,d){if(b||(b=0),c||(c=""),d||(d=2097152),!window.openDatabase)throw new Error("Your browser doesn't support SQLite. Firefox has no plan to support SQLite.");var e=openDatabase(a,b,c,d);return e}function async_sqlite_exec(a,b,c){var d=sqlite_open(b);d.transaction(function(b){b.executeSql(c,[],function(b,c){for(var d=c.rows.length,e=Array(d+1),f=0;d>f;f++){var g=c.rows.item(f);if(0==f){e[0]=[];for(var h in g)e[0].push(h)}e[f+1]=[];for(var h in g)e[f+1].push(g[h])}0==d?a(!0,1):a(e,1)},function(){a(!1,1)})})}function async_sqlite_insert(a,b,c,d){var e=d.length,f=d[0].length,g=0,h=0,i=sqlite_open(b);i.transaction(function(b){for(var i=Array(f),j=0;f>j;j++)i[j]="?";for(var k="",l="INSERT "+k+" INTO "+c+" (["+d[0].join("],[")+"]) values ("+i.join(",")+")",m=1;e>m;m++)b.executeSql(l,d[m],null,function(b,d){d.code?(0===h&&a(d.message,-1),h++):(g++,g===e&&a(c,1))},function(){})},function(){})}function idb_open(a,b,c,d,e){if(!window.indexedDB)throw new Error("Your browser doesn't support IndexedDB. Such and such feature will not be available.");var f=window.indexedDB.open(a);return f.onsuccess=function(){var a=f.result;a.onerror=function(a){var b="db_error: "+a.target.error.message;e?e(b):console.error(b)},a.onversionchange=function(){},c?c(a):console.warn("idb_open: no event handler 'success'.")},f.onupgradeneeded=function(a){var b=a.target.result;d?d(b):console.warn("idb_open: no event handler 'onupgradeneeded'.")},f.onblocked=function(){var a="idb_open_blocked: database is currently in use and can't upgrade schema";e?e(a):console.error(a)},f.onerror=function(){var a="idb_open_error: "+f.errorCode;e?e(a):console.error(a)},"#ASYNC: asynchronous functions should be call with a '&' at the end =fct(arg0,arg1) &"}function async_idb_create(a,b,c,d,e){idb_open(b,c,function(){a(d,1)},function(b){{var c=b.createObjectStore(d,{keyPath:e});b.createObjectStore("id",{autoIncrement:!0})}c.createIndex("name","name",{unique:!1}),c.createIndex("email","email",{unique:!0});var f={};f[e]="coucou",c.add(f),f[e]="doudou",c.add(f),a(d,1)})}function async_idb_select(a,b,c,d){idb_open(b,void 0,function(b){var e=b.transaction([c]),f=e.objectStore(c),g=f.get(d);g.onerror=function(){a("db_select: error",-1)},g.onsuccess=function(){var b=g.result;a(b,1)}})}function async_idb_insert(a,b,c,d,e){idb_open(b,void 0,function(b){var f=b.transaction([c],"readwrite");f.oncomplete=function(){a(c,1)},f.onerror=function(b){console.log("db_insert: insert error",b.target.error.message);"db_insert: transaction error. "+b.target.error.message;a(c,-1)};for(var g=f.objectStore(c),h=1,i=d.length;i>h;h++){for(var j={},k=0,l=d[0].length;l>k;k++)j[d[0][k]]=d[h][k];console.log("db_insert: inserting",j);var m;m="replace"===e?g.put(j):g.add(j),m.onsuccess=function(a){console.log("db_insert: insert success");a.target.result==j[d[0][0]]},m.onerror=function(a){console.log("db_insert: insert error.",a.target.error.message)}}})}function async_idb_delete(a,b){idb_open(b,void 0,function(b){var c=b.transaction([store],"readwrite").objectStore(store).delete(key);c.onsuccess=function(){a(!0,1)}})}function init_formula_editor(a,b,c){function d(){var a=u.val();-1==a.indexOf(":")&&u.val(a+":"+a.replace(/[0-9]+/,"?"))}function e(a){function b(a){function b(a){return function(){console.log(a+" saved")}}function c(a){return function(){console.error(a+" failed to saved")}}require(["storage/storage"],function(d){for(var e=(JSON.stringify(a,null,"  "),1);e<a.paths.length;e++){var f=a.paths[e];d.set_text(f,JSON.stringify(a,null,"  "),b(f),c(f))}})}b(a)}function f(){}function g(c,d){function e(a){a.stopImmediatePropagation(),a.preventDefault()}{var f=c.target;document.getElementById("vision_grid")}if("LABEL"!=f.nodeName){{var g=c.keyCode;c.key}if(!E&&d){if(g==J||g==_)return b.mode?(b.paste(G,!1),b.exit_copy_mode()):(k(),m()),e(c);if(g==bb||g==ab)return a.evaluate_sheet(function(){hot_render()},function(){hot_render()}),e(c);if(g==P)return a.del_rng_input(u.val()),e(c);{var i="C".charCodeAt(0),j="V".charCodeAt(0),p="X".charCodeAt(0);"D".charCodeAt(0),"R".charCodeAt(0)}if((c.ctrlKey||c.metaKey)&&g==i)return b.copy(G),e(c);if((c.ctrlKey||c.metaKey)&&g==p)return b.cut(G),e(c);if((c.ctrlKey||c.metaKey)&&g==j)return b.paste(G,c.shiftKey),e(c);if((c.ctrlKey||c.metaKey)&&g==O)return b.insert(G),e(c);if((c.ctrlKey||c.metaKey)&&g==P)return b.remove(G),e(c)}if(E){if(g==J)return c.ctrlKey&&c.shiftKey&&"{"!=B.val()[0]&&B.val("{"+B.val()+"}"),l(!0),e(c);if(g==L)return l(!1),e(c);if(!d&&(g==I||g==M||g==N)&&!d&&o(B.val())){var q={i:0,j:0};return g==M&&(q.i=-1),g==N&&(q.i=1),n(void 0,q),e(c)}if(d){if(g==H)return h(),e(c);if(g==P)return h(!0),e(c)}}}}function h(a){var b=B.val(),c=B.get(0),d=!c.setSelectionRange;if(!d){var e=c.selectionStart,f=c.selectionEnd;e==f&&(a?f++:e--),b=b.substr(0,e)+""+b.substr(f),B.val(b),c.setSelectionRange&&c.setSelectionRange(e,e)}if(d){b=b.substr(0,b.length-1),B.val(b);var g=b.length;c.setSelectionRange&&c.setSelectionRange(g,g)}}function i(a){k(),B.val(a);var b=B.get(0).value.length,c=B.get(0);c.setSelectionRange&&c.setSelectionRange(b,b)}function j(a){var b=B.val(),c=B.get(0),d=!c.setSelectionRange;if(!d){var e=(c.selectionStart,c.selectionEnd);b=b.substr(0,e)+a+b.substr(e),B.val(b);var f=e+a.length;c.setSelectionRange&&c.setSelectionRange(f,f)}if(d){b+=a,B.val(b);var g=b.length;c.setSelectionRange&&c.setSelectionRange(g,g)}}function k(){E=!0,F="",C.css({color:"#3276b1"}),b.exit_copy_mode()}function l(b){E=!1,F="",C.css({color:"lightgrey"});var c=B.val(),d=u.val(),e=a.range_parse(d);b?a.set_rng_input(e,c,{bEvalInput:!0,onInputSet:hot_render}):B.val(""),n(e,{i:1,j:0})}function m(){c.deselectCell(),B.focus(),setTimeout(function(){B.focus()},10)}function n(a,b){if(a||(a=G),!a){u.val()}b||(b={i:0,j:0}),c.selectCell(a.row+b.i,a.col+b.j),setTimeout(function(){c.selectCell(a.row+b.i,a.col+b.j)},10)}function o(a){var b=a&&a.substr&&("="==a[0]||"="==a[1]);return b}function p(a){var b=a.keyCode,c=a.key;if(c&&1===c.length)return c;if(!(a.ctrlKey||a.altKey||a.metaKey)){if(b>=R&&S>=b)return String.fromCharCode(a.shiftKey?b:b+32);if(!a.shiftKey&&b>=96&&105>=b)return String.fromCharCode(b-48);if(!a.shiftKey&&b>=48&&57>=b)return String.fromCharCode(b);if(qb[b])if(a.shiftKey){if(qb[b][1])return qb[b][1]}else if(qb[b][0])return qb[b][0]}}function q(b,c){var d;d="LABEL"==c.target.nodeName?c.target.textContent:c.target.hasAttribute("name")?c.target.getAttribute("name"):c.target.parentNode.getAttribute("name");var e=G;a.foreach_cell_in_range(e,function(c,e){var f=a.get_dynarray_value(a.format,c,e,{});f[b]=d,a.format[c][e]=f});var f=a.get_dynarray_value(a.format,e.row,e.col);s(f),hot_render()}function r(){var b=G,c=a.get_dynarray_value(a.format,b.row,b.col,{}),d=!!c.border;a.foreach_cell_in_range(b,function(c,e){var f=a.get_dynarray_value(a.format,c,e,{});if(d)return void delete f.border;var g="";c==b.row&&(g+="border-top "),e==b.col&&(g+="border-left "),b.end?(c==b.end.row&&(g+="border-bottom "),e==b.end.col&&(g+="border-right ")):(c==b.row&&(g+="border-bottom "),e==b.col&&(g+="border-right ")),f.border=g,a.format[c][e]=f});var c=a.get_dynarray_value(a.format,b.row,b.col);s(c),hot_render()}function s(a){$(".vision_format").css({color:"lightgrey"}),$("#vision_format_class_label").text(""),$("#vision_format_text_label").text(""),a&&(a.align&&$('.vision_format_align[name="'+a.align+'"]').css({color:"#3276b1"}),a.overflow&&$('.vision_format_overflow[name="'+a.overflow+'"]').css({color:"#3276b1"}),a.border&&$("#vision_format_border").css({color:"#3276b1"}),a.css&&$("#vision_format_class_label").text(a.css),a.fmt&&$("#vision_format_text_label").text(a.fmt))}var t=$("#formulabar"),u=t.append('<input id="vision_address" type="text" style="width:90px; height:25px;"></input> ');t.append('<input id="vision_formula" type="text" style="min-width:25%; height:25px;"></input> '),t.append('<span id="vision_formula_enter" class="glyphicon glyphicon-ok vision_formula_buttons"></span> '),t.append('<span id="vision_formula_array" class="glyphicon glyphicon-check vision_formula_buttons"></span> '),t.append('<span id="vision_formula_abort" class="glyphicon glyphicon-remove vision_formula_buttons"></span> '),t.append("&nbsp;&nbsp; - &nbsp;&nbsp;"),t.append('<div class="dropdown" style="display: inline-block;"><a data-toggle="dropdown" href="#"><span class="glyphicon glyphicon-leaf vision-theme"></span> Menu</a><ul id="formulabar_file_menu" class="dropdown-menu" role="menu" aria-labelledby="dLabel"></ul></div>'),$menu=$("#formulabar_file_menu");var v=[["Fibonacci","fibonacci"],["Alter","gridalter"],["Big data","bigdata"],["Indexed DB","indexeddb"],["Async Threads","async-threads"],["HTML Content","htmlcontent"],["SVG Graph","svggraph"]];$menu.append('<li role="presentation" class="dropdown-header">File</li>');for(var w in v)$menu.append('<li><a id="'+v[w][1]+'"><span class="glyphicon glyphicon-edit vision-theme"></span> '+v[w][0]+"</a></li>");$("#fibonacci").click(function(){open_workbook_url("demo-fibonacci.xjson")}),$("#gridalter").click(function(){open_workbook_url("demo-gridalter.xjson")}),$("#database").click(function(){open_workbook_url("demo-bigdata.xjson")}),$("#indexeddb").click(function(){open_workbook_url("demo-indexeddb.xjson")}),$("#async-threads").click(function(){open_workbook_url("demo-async-threads.xjson")}),$("#htmlcontent").click(function(){open_workbook_url("demo-html.xjson")}),$("#svggraph").click(function(){open_workbook_url("demo-svggraph.xjson")}),$menu.append('<li><a id="save" href="#"><span class="glyphicon glyphicon-cloud-upload vision-theme"></span> Save</a></li>'),$menu.append('<li role="presentation" class="divider"></li>'),$menu.append('<li role="presentation" class="dropdown-header">Refresh</li>'),$menu.append('<li><a id="refresh" href="#"><span class="glyphicon glyphicon-fire vision-theme"></span> Minimal refresh. (F5 or F9)</a></li>'),$menu.append('<li><a id="refresh_all" href="#"><span class="glyphicon glyphicon-fire vision-theme"></span> Full refresh. Dependency tree and values. (Ctrl-Shift-F5)</a></li>'),$menu.append('<li role="presentation" class="divider"></li>'),$menu.append('<li><a id="internal_details" href="#"><span class="glyphicon glyphicon-tint vision-theme"></span> Logs</a></li>'),t.append("&nbsp;&nbsp; - &nbsp;&nbsp;"),t.append('<span name="left" class="glyphicon glyphicon-align-left vision_format vision_format_align" data-toggle="tooltip" title="Align left"></span> '),t.append('<span name="center" class="glyphicon glyphicon-align-center vision_format vision_format_align" data-toggle="tooltip" title="Center"></span> '),t.append('<span name="right" class="glyphicon glyphicon-align-right vision_format vision_format_align" title="Align right"></span> '),t.append("&nbsp;"),t.append('<span name="ellipsis" class="glyphicon glyphicon-unchecked vision_format vision_format_overflow" data-toggle="tooltip" title="Truncate content and show ellipsis..."></span>'),t.append('<span name="overflow" class="glyphicon glyphicon-log-out vision_format vision_format_overflow" data-toggle="tooltip" title="Let content overflow the cell"></span> '),t.append("&nbsp;"),t.append('<span id="vision_format_border" class="glyphicon glyphicon-align-justify vision_format"  data-toggle="tooltip" title="Draw border"></span> '),t.append("&nbsp;"),t.append('<div class="dropdown" style="display: inline-block;"><a data-toggle="dropdown" href="#"><span class="glyphicon glyphicon-tint vision-theme"></span></a><ul id="formulabar_style_menu" class="dropdown-menu" role="menu" aria-labelledby="dLabel"><li role="presentation" class="dropdown-header">Style (CSS)</li></ul></div>'),$menu=$("#formulabar_style_menu");var x=["title","label","input","output","table"];for(var y in x)$menu.append('<li><a class="vision_format_class" name="'+x[y]+'"><span class="glyphicon glyphicon-tint vision-theme"></span> '+x[y]+"</a></li>");$menu.append('<li><a class="vision_format_class" name=" ">(none)</a></li>'),t.append('<div class="dropdown" style="display: inline-block;"><a data-toggle="dropdown" href="#"><span class="glyphicon glyphicon-gbp vision-theme"></span></a><ul id="formulabar_format_menu" class="dropdown-menu" role="menu" aria-labelledby="dLabel"><li role="presentation" class="dropdown-header">Numbers</li></ul></div>'),$menu=$("#formulabar_format_menu");var z=[["1.23k","0.00 a"],["1,234","0."],["1,234.00","0.00"],["1,234.0000","0.0000"],["0%","0%"],["0.00%","0.00%"],["0.0000%","0.0000%"]];for(var A in z)$menu.append('<li><a class="vision_format_text" name="'+z[A][1]+'"><span class="glyphicon glyphicon-gbp vision-theme"></span> '+z[A][0]+"</a></li>");$menu.append('<li><a class="vision_format_texte" name=" ">(none)</a></li>'),$menu.append('<li role="presentation" class="divider"></li>'),$menu.append('<li role="presentation" class="dropdown-header">Dates</li>');var z=["yyyy-mm-dd","yyyy-mm-dd hh:mm","hh:mm:ss","ddd dd-mmm","dd-mmm-yyyy"];for(var A in z)$menu.append('<li><a class="vision_format_text" name="'+z[A]+'"><span class="glyphicon glyphicon-gbp vision-theme"></span> '+z[A]+"</a></li>");$("#save").click(function(){var b=a.save_workbook();e(b)}),$("#refresh").click(function(){a.evaluate_sheet()}),$("#refresh_all").click(function(){a.reset_all_listeners(),a.evaluate_sheet()}),$("#internal_details").click(function(){$("#vision_log_modal").modal()});var u=$("#vision_address"),B=$("#vision_formula"),C=$(".vision_formula_buttons"),D=$(".vision_format");C.css({color:"lightgrey"}),D.css({color:"lightgrey"});var E=!1,F="",G=void 0;B.on("input",function(){k()}),B.on("click",function(){k()}),B.keydown(function(a){g(a)}),u.on("focus",d),u.on("click",d),u.keydown(function(b){if(b.keyCode==J){var c=u.val(),d=a.range_parse(c);n(d)}}),$("#vision_formula_enter").click(function(){l(!0)}),$("#vision_formula_array").click(function(){B.val("{"+B.val()+"}"),l(!0)}),$("#vision_formula_abort").click(function(){l(!1)}),f.prototype.on_foreign_key=function(a){{var b=a.target;document.getElementById("vision_grid")}if("LABEL"!=b.nodeName){var c=p(a);return void 0!==c?(E?j(c):("+"==c&&(c="=+"),"-"==c&&(c="=-"),i(c),m()),a.stopImmediatePropagation(),a.preventDefault(),!0):g(a,!0)}},f.prototype.on_range_selection=function(b){var c=!0;if(G=$.extend(c,{},b),E){var d=a.range_parse(u.val()),e=B.val();if(!o(e))return void l(!1);var f=0;0==f&&(Math.abs(b.row-d.row)>1&&(b.abs_row=!0),Math.abs(b.col-d.col)>1&&(b.abs_col=!0),b.end&&Math.abs(b.end.row-d.row)>1&&(b.end.abs_row=!0),b.end&&Math.abs(b.end.col-d.col)>1&&(b.end.abs_col=!0));var g=a.range_address_A1(b),h=F,i=B.get(0),j=!i.setSelectionRange;if(!j){var k=i.selectionStart,m=i.selectionEnd;e=e.substr(0,k)+g+e.substr(m),B.val(e),i.setSelectionRange&&i.setSelectionRange(k,k+g.length)}if(j){var n=e.substr(e.length-h.length);n==h&&(e=e.substr(0,e.length-h.length)),e+=g,B.val(e);var p=e.length;i.setSelectionRange&&i.setSelectionRange(p,p)}F=g}else{var q=a.get_rng_input(b);B.val(q.formula);var b=a.range_union(b,q.ref),r=a.range_address_A1(b);u.val(r);var t=a.get_dynarray_value(a.format,G.row,G.col);s(t)}};var H=8,I=9,J=13,K=20,L=27,M=38,N=40,O=45,P=46,Q=61,R=65,S=90,T=48,U=57,V=106,W=107,X=109,Y=111,Z=187,_=113,ab=116,bb=120,cb=168,db=169,eb=170,fb=171,gb=189,hb=191,ib=219,jb=221,kb=186,lb=222,mb=220,nb=188,ob=190,pb=!0,qb={};return qb[W]=["+","+"],qb[X]=["-","-"],qb[V]=["*","*"],qb[Y]=["/","/"],qb[Z]=["=","+"],qb[fb]=["+",void 0],qb[gb]=["-",pb?"_":void 0],qb[eb]=["*",void 0],qb[hb]=["/",pb?"?":void 0],qb[Q]=["=","+"],qb[K]=[" "," "],qb[nb]=[",",pb?"<":void 0],qb[ob]=[".",pb?">":void 0],qb[cb]=["(",void 0],qb[db]=[")",void 0],qb[U]=[void 0,pb?"(":void 0],qb[T]=[void 0,")"],qb[ib]=["[",pb?"{":void 0],qb[jb]=["]",pb?"}":void 0],qb[kb]=[";",pb?":":void 0],qb[lb]=["'",pb?'"':void 0],qb[mb]=["\\",pb?"|":void 0],$("#vision_format_text").autocomplete({source:["0%","0.00%","0.0000%","0a","0.00a","0.0000a","0,0","0,0.00","0,0.0000","(0,0.00)","00:00:00"]}),$(".vision_format_align").click(function(a){q("align",a)}),$(".vision_format_overflow").click(function(a){q("overflow",a)}),$(".vision_format_class").click(function(a){q("css",a)}),$(".vision_format_text").click(function(a){q("fmt",a)}),$("#vision_format_border").click(r),$(".vision_format").tooltip({placement:"bottom",title:"tototo"}),$("#vision_format_class_label").on("input",function(a){q("css",a)}),$("#vision_format_text_label").on("input",function(a){q("fmt",a)}),new f}function init_gridalter(a,b){function c(){this.srce=void 0,this.mode=void 0}function d(){}function e(b,c,e,h){if(!c)return!1;if(c.end||e.end){c.end&&!e.end&&(e.end={row:e.row+(c.end.row-c.row),col:e.col+(c.end.col-c.col)}),!c.end&&e.end,assert_msg(c.end&&e.end,"copy-cut-paste: range of different size");var i=c.end.row-c.row==e.end.row-e.row&&c.end.col-c.col==e.end.col-e.col;assert_msg(i,"copy-cut-paste: range of different size")}var j=a.test_partial_ref(c);j&&!h.skip_partial_check&&error_msg("partial_ref: source "+j.msg);var k={cells:[[]],values:[[]],listeners:[[]],format:[[]]};f(c,a,k),"cut"==b&&a.del_rng_input(c,d);var l=a.test_partial_ref(e);l&&!h.skip_partial_check&&("cut"==b&&f(c,k,a),error_msg("partial_ref: dest "+l.msg)),a.del_rng_input(e,d),"cut"==b&&(g(a.cells,c,e,!1),g(k.cells,c,e,!0)),a.foreach_cell_in_range(c,function(c,d,f,g){var i=a.get_dynarray_value(k.cells,c,d),j=a.get_dynarray_value(k.values,c,d),l=(a.get_dynarray_value(k.listeners,c,d),a.get_dynarray_value(k.format,c,d));i&&i.value&&(h.byValue?a.set_rng_input({row:e.row+f,col:e.col+g},i.value):(a.set_cell_input(e.row+f,e.col+g,i),a.set_dynarray_value(a.values,e.row+f,e.col+g,j),a.set_dynarray_value(a.format,e.row+f,e.col+g,l),i.formula&&(i.formula=void 0),i.status&&"copy"==b&&(i.status=0)))})}function f(b,c,d){var e=!0;a.foreach_cell_in_range(b,function(b,f){a.set_dynarray_value(d.cells,b,f,$.extend(e,{},a.get_dynarray_value(c.cells,b,f))),a.set_dynarray_value(d.values,b,f,a.get_dynarray_value(c.values,b,f)),a.set_dynarray_value(d.listeners,b,f,$.extend(e,{},a.get_dynarray_value(c.listeners,b,f))),a.set_dynarray_value(d.format,b,f,$.extend(e,{},a.get_dynarray_value(c.format,b,f)))})}function g(b,c,d,e){if(!c.end){var f=!0;c=$.extend(f,{},c),c.end=c}var g=d?{i:d.row-c.row,j:d.col-c.col}:void 0;a.foreach_cell_in_dynarray(b,function(a,b,d){var f={row:b,col:d};h(a,f,c,g,e)})}function h(a,b,c,d,e){if(a.ref&&i(a.ref,b,c,d,e),a.parsed_args)for(var f=0,g=a.parsed_args.length;g>f;f++)i(a.parsed_args[f],b,c,d,e);a.formula&&a.parsed_formula&&delete a.formula}function i(b,c,d,e,f){var g;if(void 0===b.row_add)g=d.row<=b.row&&d.col<=b.col&&b.row<=d.end.row&&b.col<=d.end.col,e?f?f&&g&&g&&(b.row+=e.i,b.col+=e.j):g&&(b.row+=e.i,b.col+=e.j):g&&(b.row=-b.row-2),b.end&&i(b.end,c,d,e,f);else{var h=b;b=a.range_from_add_mult(h,c),g=d.row<=b.row&&d.col<=b.col&&b.row<=d.end.row&&b.col<=d.end.col,e?f?f&&(g?(h.row_add+=0===h.row_mult?+e.i:0,h.col_add+=0===h.col_mult?+e.j:0):(h.row_add+=0!==h.row_mult?-e.i:0,h.col_add+=0!==h.col_mult?-e.j:0)):g&&(h.row_add+=e.i,h.col_add+=e.j):g&&(h.row_mult=-h.row_mult,h.row_add=-h.row_add-2),h.end&&i(h.end,c,d,e,f)}}return c.prototype.copy=function(a){this.srce=a,this.mode="copy"},c.prototype.cut=function(a){this.srce=a,this.mode="cut"},c.prototype.exit_copy_mode=function(){this.srce=void 0,this.mode=void 0},c.prototype.paste=function(a,c){var d=this.mode,f=this.srce;this.exit_copy_mode(),e(d,f,a,{byValue:c}),b.render()},c.prototype.insert=function(c,d){assert_msg("row"==d.what,"insert: limited to rows");for(var f=a.last_cell(),g=c.end.row-c.row+1,h=0;g>h;h++){var i=f.row+1;b.alter("insert_row",i)}var j={row:c.row,col:0,end:{row:f.row,col:f.col}},k={row:c.row+g,col:0,end:{row:f.row+g,col:f.col}};e("cut",j,k,{skip_partial_check:!0});var l=c.row-1;i1=c.end.row+1;for(var m=0;m<f.col;m++){a.get_dynarray_value(a.cells,l,m),a.get_dynarray_value(a.cells,i1,m)}a.reset_all_listeners(),b.render()},c.prototype.remove=function(c,d){assert_msg("row"==d.what,"remove: limited to rows"),c={row:c.row,col:0,end:{row:c.end.row,col:999}},a.del_rng_input(c,!0),g(a.cells,c);var f={row:c.row+n,col:0,end:{row:last_cell.row+n,col:last_cell.col}},h={row:c.row,col:0,end:{row:last_cell.row,col:last_cell.col}};e("cut",f,h,{skip_partial_check:!0}),a.reset_all_listeners(),b.render()},new c}function open_workbook_url(a){$.ajax({url:a,dataType:"json",success:function(a){model.open_workbook(a),hot_render()},error:function(a){alert(JSON.stringify(a))}})}function hot_render(){var a=$("#vision_grid").handsontable("getInstance");return a.render()}function hot_data_rng(a,b,c,d){var e=$("#vision_grid").handsontable("getInstance");return e.getData(a,c,b,d)}function gridmodel_module(){function a(){this.values=[[]],this.cells=[[]],this.listeners=[[]],this.format=[[]],this.error=function(a){alert(a)}}function b(a){function c(a,b){var d=a%26;return b=String.fromCharCode("A".charCodeAt(0)+d)+(b?b:""),a=(a-d)/26,1>a?b:c(a-1,b)}var d=a.bRef?"@":"";return d+=a.abs_col?"$":"",d+=c(a.col),d+=a.abs_row?"$":"",d+=a.row+1,!a.end||a.end.row==a.row&&a.end.col==a.col||(d+=":"+b(a.end)),d}function c(a){function b(a){var c=a.charCodeAt(0)-"A".charCodeAt(0);return a.length>1?26*(c+1)+b(a.substr(1)):c}function c(a){var c=!1,d=!1;a=a.trim(),"$"==a[0]&&(d=!0,a=a.substr(1)),-1!==a.indexOf("$")&&(c=!0,a=a.replace("$",""));var e=a.search(/[0-9]/),f=a.substr(0,e).toUpperCase(),g=a.substr(e);return f=b(f),g=parseInt(g)-1,{row:g,col:f,abs_row:c,abs_col:d}}if(void 0!==a.row)return a;var d="@"==a[0];d&&(a=a.substr(1));var e=a.split(":");if(1==e.length){var f=a.substr(a.search(/\d/)),g=f.search(/[^0-9]/);if(-1!=g){var h=f.substr(g),i=a.substr(0,h.length);e=[i,h]}}var j=c(e[0]);return 2==e.length&&(j.end=c(e[1])),j.bRef=d,j}function d(a,b){var c={row_mult:a.abs_row?0:1,row_add:a.abs_row?a.row:a.row-b.row,col_mult:a.abs_col?0:1,col_add:a.abs_col?a.col:a.col-b.col};return a.end&&(c.end=d(a.end,b)),a.bRef&&(c.bRef=a.bRef),c}function e(a,b){var c={row:a.row_mult*b.row+a.row_add,col:a.col_mult*b.col+a.col_add,abs_row:0===a.row_mult,abs_col:0===a.col_mult};return a.end&&(c.end=e(a.end,b)),a.bRef&&(c.bRef=a.bRef),c}function f(a,b){return b||(b=a),a.end=a.end?a.end:a,b.end=b.end?b.end:b,{row:Math.min(a.row,b.row),col:Math.min(a.col,b.col),end:{row:Math.max(a.end.row,b.end.row),col:Math.max(a.end.col,b.end.col)}}}function g(a,b){var e,f=!1;if("="==a[0])e=a.substr(1);else{if(!a.substr||"{="!=a.substr(0,2)||"}"!=a[a.length-1]){var g=a;try{g=JSON.parse(g)}catch(h){}return{value:g}}f=!0,e=a.substring(2,a.length-1)}for(var j=i(a+" "),k=e,l=[],m=0,n=j.length;n>m;m++){var o=c(j[m]),p=d(o,b);p.subst="$__"+m+"__",k=k.replace(j[m],p.subst),l.push(p)}var q={value:void 0,parsed_formula:k,bArrayFormula:f,parsed_args:l};return f&&(q.ref=b),q}function h(a,c,d){for(var f=a,g=0,h=c.length;h>g;g++){var i=c[g],j=e(i,d),k=b(j);i.subst!=k&&(f=f.replace(i.subst,k))}return f}function i(a){for(var b,c=[];null!==(b=z.exec(a));)c.push(b[1]),z.lastIndex--;return z.lastIndex=0,c=j(c)}function j(a){for(var b={},c=[],d=0,e=a.length;e>d;++d)a[d]in b||(b[a[d]]=!0,c.push(a[d]));return c}function k(a){if(void 0===a)return a;var b=JSON.parse(JSON.stringify(a));return b}function l(a,b){var c=[],d=[];for(var e in b)c.push(e),d.push(b[e]);var f=c.concat(["return "+a+";"]),g=Function.prototype.constructor.apply(void 0,f),h=g.apply(g,d);return h}function m(a,b,c,d){void 0===a[b]&&(a[b]=[]),a[b][c]=d}function n(a,b,c,d){if(void 0===a[b]){if(!d)return;a[b]=[]}return void 0===a[b][c]&&d&&(a[b][c]=d),a[b][c]}function o(a,b,c){void 0!==a[b]&&void 0!==a[b][c]&&delete a[b][c]}function p(a,b){for(var c in a)for(var d in a[c]){var e=n(a,+c,+d);b(e,+c,+d)}}function q(a,b){for(var c=a.end?a.end.row-a.row+1:1,d=a.end?a.end.col-a.col+1:1,e=0;c>e;e++)for(var f=0;d>f;f++)b(a.row+e,a.col+f,e,f)}function r(a,b){for(var c=a.end?a.end.row-a.row+1:1,d=a.end?a.end.col-a.col+1:1,e=0;c>e;e++)for(var f=0;d>f;f++){var g=b(a.row+e,a.col+f,e,f);if(g)return g}}var s=!0,t=!1,u=0,v=2,w=1,x=-1,y=function(){};a.prototype.clear_workbook=function(){},a.prototype.open_workbook=function(a){function b(a){return function(b,c){d.set_dynarray_value(d.format,b,c,a)}}var d=this;d.clear_workbook(),d.paths=a.paths;var e,f,g=a.format;for(var h in g)e=c(h),f=g[h],q(e,b(f));var i=a.input;for(e in i)d.set_rng_input(e,i[e])},a.prototype.save_workbook=function(){function a(){var a={};for(var c in d.cells)for(var e in d.cells[c]){var f=d.cells[c][e];if(!f.saved){var g={row:+c,col:+e};if(f.bArrayFormula&&(g=f.ref),f.ref&&!f.parsed_formula)break;if(f.parsed_formula&&!f.bArrayFormula){for(var h=+c;;h++){var i=n(d.cells,h,+e);if(!i)break;if(i.parsed_formula!=f.parsed_formula)break;i.saved=!0}h>c&&(g={row:+c,col:+e,end:{row:h-1,col:+e}})}var j=b(g),k=d.get_rng_input(g).formula;a[j]=k}}return p(d.cells,function(a){a.saved&&delete a.saved}),a}function c(){var a={};return p(d.format,function(c,d,e){if(!c.saved){var f=(JSON.stringify(c),{row:+d,col:+e}),g=b(f);a[g]=c}}),p(d.format,function(a){a.saved&&delete a.saved}),a}var d=this,e={paths:d.paths,input:a(),format:c()};return e},a.prototype.get_rng_input=function(a){var b=this;a=c(a);var d=b.get_cell_input(a.row,a.col);if(d.formula)return d;!d.parsed_formula&&d.ref&&(d=b.get_cell_input(d.ref.row,d.ref.col),d.bArrayFormula&&(a=d.ref),assert_msg(d.parsed_formula,"get_rng_input: dangling ref. should cleanup dependency tree."));var e=void 0!==d.value?d.value:"";return d.parsed_formula&&(e=h(d.parsed_formula,d.parsed_args,a),e="="+e,d.bArrayFormula&&(e="{"+e+"}")),d.formula=e,d},a.prototype.del_rng_input=function(a){var b=this;a=c(a),q(a,function(a,c){b.unregister_listener(a,c),o(b.cells,a,c),m(b.values,a,c,null)})},a.prototype.set_rng_input=function(a,d,e){var h=this,i=e?e:{bEvalInput:!1};a=c(a);var j=h.get_cell_input(a.row,a.col);j&&j.bArrayFormula&&(a=f(a,j.ref)),q(a,function(a,b){h.unregister_listener(a,b)});var l=r(a,function(c,d){var e=n(h.cells,c,d);return!e||!e.ref||!e.bArrayFormula&&e.parsed_formula||a.row==e.ref.row&&a.col==e.ref.col?void 0:{error:"set_rng_input: target range "+b(a)+" intersecting existing "+b(e.ref)+"."}});l&&error_msg(l.error);var m,o,p,s=a.end&&(a.end.row!=a.row||a.end.col!=a.col),t=Array.isArray(d),u=!t&&d&&d.substr&&"{="==d.substr(0,2)&&"}"==d[d.length-1],v=s&&!t,w=a.end?a.end.row-a.row+1:1,x=a.end?a.end.col-a.col+1:1,z=a;if(u){var A=k(z);for(m=0;w>m;m++)for(o=0;x>o;o++)h.set_cell_input(a.row+m,a.col+o,{ref:A});p=g(d,z),h.set_cell_input(a.row,a.col,p),w=x=1}else if(v)for(p=g(d,z),delete p.formula,m=0;w>m;m++)for(o=0;x>o;o++){var B=k(p);h.set_cell_input(a.row+m,a.col+o,B)}else if(s&&t)for(assert_msg(w==d.length,"set_rng_input"),assert_msg(x==d[0].length,"set_rng_input"),m=0;w>m;m++)for(o=0;x>o;o++)h.set_cell_input(a.row+m,a.col+o,g(d[m][o],{row:a.row+m,col:a.col+o}));else h.set_cell_input(a.row,a.col,g(d,z));for(m=0;w>m;m++)for(o=0;x>o;o++){var C=a.row+m,D=a.col+o,E=h.cells[C][D];E.parsed_formula?i.bEvalInput&&h.evaluate_cell(C,D,i.onInputSet?i.onInputSet:y):h.set_cell_value(C,D,E.value)}i.onInputSet&&i.onInputSet()},a.prototype.get_cell_input=function(a,b){var c=this,d=n(c.cells,a,b);return d?d:{}},a.prototype.test_partial_ref=function(a){var c=this,d=r(a,function(d,e){var f=n(c.cells,d,e);if(f&&f.ref&&(f.bArrayFormula||!f.parsed_formula)){var g=a.row>f.ref.row||a.col>f.ref.col;if(!g){var h=a.end?a.end:a,i=f.ref.end?f.ref.end:f.ref;g=h.row<i.row||h.col<i.col}if(g)return{msg:"range "+b(a)+" intersecting existing "+b(f.ref)+".",rng:f.ref}}});return d},a.prototype.last_cell=function(){var a=this,b=0,c=0;return p(a.cells,function(a,d,e){b=Math.max(b,d),c=Math.max(c,e)}),{row:b,col:c}},a.prototype.set_cell_input=function(a,b,c){var d=this;m(d.cells,a,b,c),d.register_listener(a,b),d.fire_cell_out_of_date(a,b)},a.prototype.register_listener=function(a,b){var c=this,d=n(c.cells,a,b);if(d&&d.parsed_args)for(var f=d.parsed_args,g={row:a,col:b},h=a+"-"+b,i=function(a,b){var d=n(c.listeners,a,b,{});d[h]=g},j=0,k=f.length;k>j;j++){var l=e(f[j],g);q(l,i)}},a.prototype.unregister_listener=function(a,b){var c=this,d=n(c.cells,a,b);if(d&&d.parsed_args)for(var f=d.parsed_args,g={row:a,col:b},h=a+"-"+b,i=function(a,b){var d=c.listeners[a][b];d&&delete d[h]},j=0,k=f.length;k>j;j++){var l=e(f[j],g);q(l,i)}},a.prototype.fire_cell_out_of_date=function(a,b,c){function d(a,b,c){var g=n(e.cells,a,b);if(!g)return{dangling_listener:"clean-up needed: dangling listener.",listening:{row:a,col:b}};if(c&&!g.parsed_formula)return{dangling_listener:"clean-up needed: dangling listener (a listener is necessary a formula).",listening:{row:a,col:b}};if(c&&void 0===g.status)return{dangling_listener:"clean-up needed: dangling listener (a listener is necessary a formula so it must have a status defined).",listening:{row:a,col:b}};if(g.status!==u){if(g.status===f)return{circular:[{row:a,col:b}]};g.status=f;var h=g.bArrayFormula?g.ref:{row:a,col:b},i=r(h,function(a,b){var c=n(e.listeners,a,b,{});for(var f in c){var g=c[f],h=d(g.row,g.col,!0);if(h)return h.circular&&h.circular.unshift({row:a,col:b}),h.listening&&!h.listened&&(h.listened={row:a,col:b}),h}});return g.status=u,i}}var e=this,f=777,g=!1,h=d(a,b,g);if(h){var i,j=n(e.cells,a,b);h.dangling_listener&&(i="set_cell_input: detected a dangling_listener. Range "+model.range_address_A1(h.listened)+" listened by "+model.range_address_A1(h.listening)+".",j.error=i,s||c||(e.reset_all_listeners(),c=!0,fire_cell_out_of_date(a,b,c))),h.circular&&(h.circular=h.circular.map(model.range_address_A1),i="set_cell_input: detected a circular reference. Loop path : "+JSON.stringify(h.circular)+".",e.unregister_listener(a,b),j.parsed_formula="' "+j.parsed_formula,j.parsed_args=[],j.error=i),console.warn(i),e.reset_all_status()}},a.prototype.reset_all_status=function(){var a=this;console.warn("reset_all_status"),p(a.cells,function(a){a&&a.status&&(a.status=u)}),done()},a.prototype.reset_all_listeners=function(){var a=this;console.warn("reset_all_listeners"),a.listeners=[[]],p(a.cells,function(b,c,d){if(a.register_listener(c,d),b.bArrayFormula){var e=k(b.ref);q(b.ref,function(b,c){(b!=e.row||c!=e.col)&&a.set_cell_input(b,c,{ref:e})})}}),a.reset_all_status()};var z=/[=+\-*\/,?( ](@?\$?[A-Z]+\$?[0-9]+(:\$?[A-Z]+\$?[0-9]+)?)[=+\-*\/.?, )}]/gim;a.prototype.evaluate_args=function(a,b){function c(a,b,c,e){for(var f=b-a+1,g=new Array(f),h=0;f>h;h++)g[h]=d.values[a+h].slice(c,e+1);return g}for(var d=this,f={},g=0,h=a.length;h>g;g++){var i,j=a[g],k=e(j,b);i=k.end?c(k.row,k.end.row,k.col,k.end.col):k.bRef?n(d.cells,k.row,k.col).value:n(d.values,k.row,k.col),f[j.subst]=i}return f},a.prototype.evaluate_cell=function(a,c,d){function e(a,b,c,d){return Array.isArray(a)?b>=a.length?d:Array.isArray(a[b])?c>=a[b].length?d:a[b][c]:0===c?a[b]:d:0===b&&0===c?a:d}var f=this,g=f.cells[a][c];if(g.ref&&(a=g.ref.row,c=g.ref.col,g=f.cells[a][c]),g.error)f.set_cell_value(a,c,g.error),g.status=x;else{if(g.parsed_formula){if(g.status==v){var h=g.start.getTime(),i=(new Date).getTime(),j=(i-h)/1e3;return g.value="... "+j+"s",f.set_cell_value(a,c,g.value),!0}var k=f.evaluate_cell_dependency(a,c,!0,!0,!1),m=void 0!==k;if(m)return g.value="#DEPS",g.status=u,void f.set_cell_value(a,c,g.value);var n=g.parsed_formula.trim(),o="&"==n[n.length-1];o&&(n=n.substr(0,n.length-1));var p=-1!=n.indexOf("async");if(p){var r=n.indexOf("async");0!==r&&info_msg("Asynchronous function should usually not be nested. You shall call them directly: =async_fct(args) or with nesting that are just passthrough : = test ? async_fct(args) : other_fct(args)."),r=n.indexOf("("),n=n.substr(0,r+1)+"async_complete, "+n.substr(r+1)}var s;(p||o)&&(assert_msg(void 0!==d,""),s=function(b,h,i){m&&i==w&&(i=u),g.value=h,g.status=i,g.bArrayFormula?q(g.ref,function(a,b,c,d){f.set_cell_value(a,b,e(g.value,c,d,"#N/A"))}):f.set_cell_value(a,c,g.value),d(b)});try{var t=f.evaluate_args(g.parsed_args,{row:a,col:c});if(p&&(t.async_complete=s),p||o){if(g.value="...",g.status=m?u:v,g.start=new Date,p)l(n,t);else if(o){var y=b({row:a,col:c});async_eval_queue(y,{type:"eval",src:n,vars:t},s)}}else g.value=l(n,t),g.status=m?u:w}catch(z){var A="#ERR "+(z.message?z.message:JSON.stringify(z))+" in "+g.parsed_formula;g.value=g.bArrayFormula?[[A]]:A,g.status=x}return g.bArrayFormula?q(g.ref,function(a,b,c,d){f.set_cell_value(a,b,e(g.value,c,d,"#N/A"))
}):f.set_cell_value(a,c,g.value),p||o?!0:!1}f.set_cell_value(a,c,g.value)}};var A=0;return a.prototype.evaluate_cell_tree=function(a,b){var c=this,d=!1;for(d&&console.log(new Date,"evaluate_cell_tree: enter. queue: ",JSON.stringify(a));a.length;){var e=a[a.length-1],f=c.cells[e.row][e.col];if(void 0!==f.ref&&void 0===f.parsed_formula&&d&&console.warn(new Date,"evaluate_cell_tree: queue started on a ref, exit",e.row,e.col),f.status==v)return d&&console.log(new Date,"evaluate_cell_tree: queue ended up on cells already being executed, exit"),b(),!0;var g=c.evaluate_cell_dependency(e.row,e.col,!0,!0,!1);if(g){if(-1!=a.indexOf(g)){error_circular=a.map(model.range_address_A1);var h="evaluate_cell_tree: detected a circular reference. Loop path : "+JSON.stringify(error_circular)+".",i=n(c.cells,row,col);c.unregister_listener(row,col),i.parsed_formula="' "+i.parsed_formula,i.parsed_args=[],error_msg(h)}a.push(g),d&&console.log(new Date,"queue incr: ",JSON.stringify(a))}else{var j=function(e){d&&console.log(new Date,"queue async (resume): ",e,JSON.stringify(a)),A--,a.pop(),c.evaluate_cell_tree(a,b)},k=c.evaluate_cell(e.row,e.col,j);if(k)return d&&console.log(new Date,"queue async (waiting): ",JSON.stringify(a)),A++,!0;a.pop(),d&&console.log(new Date,"queue decr: ",JSON.stringify(a))}}return d&&console.log(new Date,"evaluate_cell_tree: queue empty, exit"),b(),!1},a.prototype.evaluate_sheet=function(a,b){function c(){e--,0===e&&(0!==f?d.evaluate_sheet(a,b):b())}var d=this;t&&console.log("evaluate_sheet");var e=1,f=0;for(var g in d.cells)for(var h in d.cells[g])if(!d.is_valid(+g,+h)){e++,f++;{d.evaluate_cell_tree([{row:+g,col:+h}],c)}}c(),a()},a.prototype.evaluate_cell_dependency=function(a,b,c,d,f){var g=this,h=n(g.cells,a,b),i=h.parsed_args;if(i)for(var j=function(a,b){var e=g.get_invalid(a,b,c,d,f);return e?e:void 0},k=0,l=i.length;l>k;k++){var m={row:a,col:b},o=e(i[k],m),p=r(o,j);if(p)return p}},a.prototype.get_invalid=function(a,b,c,d,e){var f=this,g=n(f.cells,a,b);return g&&(g.parsed_formula||g.ref)?g.parsed_formula?c&&g.status==u||d&&g.status==v||e&&g.status==x?{row:a,col:b}:void 0:(g=n(f.cells,g.ref.row,g.ref.col),g?c&&g.status==u||d&&g.status==v||e&&g.status==x?{row:a,col:b}:void 0:void console.warn("dangling ref: but not a good place to do something about it")):void 0},a.prototype.is_valid=function(a,b){var c=this;return!c.get_invalid(a,b,!0,!0,!1)},a.prototype.is_error=function(a,b){var c=this,d=n(c.cells,a,b);if(!d)return!1;if(void 0!==d.status)return d.status==x;var e=n(c.cells,ref.row,ref.col);return e.status==x},a.prototype.set_cell_value=function(a,b,c){var d=this;m(d.values,a,b,c)},a.prototype.range_parse=c,a.prototype.range_union=f,a.prototype.range_address_A1=b,a.prototype.range_from_add_mult=e,a.prototype.get_dynarray_value=n,a.prototype.set_dynarray_value=m,a.prototype.foreach_cell_in_range=q,a.prototype.foreach_cell_in_range_test=r,a.prototype.foreach_cell_in_dynarray=p,a}function warn_msg(a){console.alert(a),window.alert(a)}function error_msg(a){throw console.error(a),window.alert(a),new Error(a)}function assert_msg(a,b){a||error_msg(b)}function WorkerPool(a){this.workers=Array(a),this.task_ids=Array(a),this.callbacks=Array(a);for(var b=0;a>b;b++)setup_worker(this,b)}function setup_worker(a,b){var c=a;c.workers[b]=new Worker("gridworker.js"),c.workers[b].onmessage=function(a){if("done"==a.data.type){var d=c.task_ids[b],e=c.callbacks[b];e(d,a.data.res,1),c.callbacks[b]=void 0,c.task_ids[b]=void 0,check_task_pool()}},c.workers[b].onerror=function(a){var d=c.task_ids[b],e=c.callbacks[b];e(d,a.filename+":"+a.lineno+" "+a.message,-1),c.callbacks[b]=void 0,c.task_ids[b]=void 0,check_task_pool()}}function async_eval_queue(a,b,c){task_queue.push({task_id:a,task:b,complete:c}),check_task_pool()}function check_task_pool(){if(0!==task_queue.length){var a=task_queue[0],b=worker_pool.submit_task(a.task_id,a.task,a.complete);b&&task_queue.shift()}}function parse_url_query_std(){var a=location.search;if(0==a.length)return{};var b=a.substring(1);b=b.replace(/\+/g," "),b=b.replace(/;/g,"&").split("&");for(var c={},d=0;d<b.length;d++){var e=b[d].split("=",2),f=unescape(e[0]);c[f]||(c[f]=[]),c[f][c[f].length]=e.length>1?unescape(e[1]):!0}return c}function parse_url_query_jsonargs(){var a=parse_url_query_std();for(var b in a)for(var c=0;c<a[b].length;c++)try{a[b][c]=json_parse(a[b][c])}catch(d){}return a}function encode_url_query(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(json_stringify(a[c])));return b.join("&")}function cache_status_string(){var a=window.applicationCache;if(!a)return"App cache not supporte";switch(a.status){case a.UNCACHED:return"Not Cached";case a.IDLE:return"Cached";case a.CHECKING:return"Checking cache";case a.DOWNLOADING:return"Downloading cache";case a.UPDATEREADY:return"Cache ready";case a.OBSOLETE:return"Cache obsolete";default:return"Unknown cache status"}}window.indexedDB||(window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange);var model;$(function(){function a(a,b){Handsontable.TextCell.renderer.apply(this,arguments),b.style.background="lightgrey"}function b(a,b){Handsontable.TextCell.renderer.apply(this,arguments),b.style.color="red"}function c(a){return!isNaN(parseFloat(a))&&isFinite(a)}function d(a,b,d,e,f,g){var h=model.get_dynarray_value(model.format,d,e);if(h&&h.fmt&&c(g)&&-1===h.fmt.indexOf("mm")&&(g=numeral(g).format(h.fmt)),"string"==typeof g&&g.length>0&&"<"==g[0]&&">"==g[g.length-1]?b.innerHTML=g:Handsontable.TextCell.renderer.apply(this,arguments),b.className="",h){var i=[h.align?h.align:"",h.overflow?h.overflow:"",h.css?h.css:"",h.border?h.border:""];i=i.join(" "),b.setAttribute("vision-class",i)}else b.setAttribute("vision-class"," ")}function e(a){s.on_foreign_key(a)}function f(a,b,c,d){var e={row:a,col:b};(a!=c||b!=d)&&(e.end={row:c,col:d}),s.on_range_selection(e)}model_module=gridmodel_module(),model=new model_module;var g=$("#vision_grid"),h={data:model.values,colHeaders:!0,rowHeaders:!0,minCols:64,minRows:48,minSpareCols:2,minSpareRows:1,outsideClickDeselects:!1,manualColumnResize:!0,manualColumnMove:!1,fillHandle:!1,beforeKeyDown:e,afterSelectionEnd:f},i=g.get(0),j=(i.getBoundingClientRect(),g.position(),g.offset(),Math.ceil(g.offset().top)),k=window!==window.parent;if(k){for(var l,m=self.parent.document.getElementsByTagName("iframe"),n=0,o=m.length;o>n&&(l=m[n],l.contentWindow!=window);n++);assert_msg(n!=o,"couldn't find frame top");var p=m[n].getBoundingClientRect();j+=p.top}self.innerHeight?(h.height=self.innerHeight-j-2,h.width=self.innerWidth-2):self.parent&&self.parent.innerHeight?(h.height=self.parent.innerHeight-j-5,h.width=self.parent.innerWidth-5):console.warn("gridedit: couldn't detect container width"),h.cells=function(c,e){var f={readOnly:!0};return f.renderer=model.is_valid(c,e)?model.is_error(c,e)?b:d:a,f},h.contextMenu={items:{tmp1:{name:"Alter:",disabled:!0},insert_row_a_moi:{name:"Insert row (Shift-'+')"},remove_row_a_moi:{name:"Remove row (Shift+'-')"},hsep1:"---------",about:{name:"About"}},callback:function(a){var b=q.getSelected();b={row:b[0],col:b[1],end:{row:b[2],col:b[3]}},setTimeout(function(){"about"===a?alert("This is a context menu with default and custom options mixed"):"insert_row_a_moi"===a?r.insert(b,{what:"row"}):"insert_col_a_moi"===a?r.insert(b,{what:"col"}):"remove_row_a_moi"===a?r.remove(b,{what:"row"}):"remove_col_a_moi"===a&&r.remove(b,{what:"col"})},10)}},g.handsontable(h);var q=g.handsontable("getInstance"),r=init_gridalter(model,q),s=init_formula_editor(model,r,q);q.selectCell(0,0);var t=parse_url_query_std();t.path&&require(["storage/storage"],function(a){a.get_text(t.path[0],function(a){var b=JSON.parse(a);model.open_workbook(b),hot_render()},function(a){console.error(a)})})}),WorkerPool.prototype.submit_task=function(a,b,c){for(var d=this.workers.length,e=0;d>e;e++)if(void 0===this.callbacks[e])return this.callbacks[e]=c,this.task_ids[e]=a,this.workers[e].postMessage(b),!0;return!1},WorkerPool.prototype.terminate_worker=function(a){var b=this;b.workers[a].terminate(),console.error("worker "+a+" terminated");var c=b.callbacks[a];c("terminated",-1),b.callbacks[a]=void 0,b.task_ids[a]=void 0,setup_worker(b,a)};var worker_pool=new WorkerPool(3),task_queue=[];